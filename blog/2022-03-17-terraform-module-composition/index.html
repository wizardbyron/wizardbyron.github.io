<!doctype html><html lang=zh class=dark><head><meta charset=utf-8><meta http-equiv=content-language content="zh"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>【翻译】Terraform 最佳实践：模块组合 &#183; 顾宇的博客</title><meta name=title content="【翻译】Terraform 最佳实践：模块组合 &#183; 顾宇的博客"><meta name=description content><link rel=canonical href=https://wwww.guyu.me/blog/2022-03-17-terraform-module-composition/><link type=text/css rel=stylesheet href=/css/schemes/slate.min.1fa9cfe6ea431f51b6669ad59d531a840711f25edf67f90d0227253371e1da49fdcc25506150e39fb99ac2c95a6012b2c4bbdd6c41b841b186419cbd7e115768.css integrity="sha512-H6nP5upDH1G2ZprVnVMahAcR8l7fZ/kNAiclM3Hh2kn9zCVQYVDjn7mawslaYBKyxLvdbEG4QbGGQZy9fhFXaA=="><link type=text/css rel=stylesheet href=/css/compiled/main.min.4076b9cf114dd23cca017f3365e2205a4c9a4b2c0ef4193ccd08883f76e554aa40f674a8f6e77a1b2895be0975ba8e019b0c59996c2eea32e4970ca4d5221653.css integrity="sha512-QHa5zxFN0jzKAX8zZeIgWkyaSywO9Bk8zQiIP3blVKpA9nSo9ud6GyiVvgl1uo4BmwxZmWwu6jLklwyk1SIWUw=="><script>function loadPreferredAppearance(){localStorage.preferredAppearance==="dark"||!("preferredAppearance"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function setPreferredAppearance(e){e=="default"?localStorage.removeItem("preferredAppearance"):localStorage.preferredAppearance=e,loadPreferredAppearance()}loadPreferredAppearance(),window.matchMedia("(prefers-color-scheme: dark)").addListener(loadPreferredAppearance)</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="【翻译】Terraform 最佳实践：模块组合"><meta property="og:description" content="原文：https://www.terraform.io/language/modules/develop/composition 在只有一个根"><meta property="og:type" content="article"><meta property="og:url" content="https://wwww.guyu.me/blog/2022-03-17-terraform-module-composition/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-03-06T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-06T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="【翻译】Terraform 最佳实践：模块组合"><meta name=twitter:description content="原文：https://www.terraform.io/language/modules/develop/composition 在只有一个根"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","articleSection":"Blogs","name":"【翻译】Terraform 最佳实践：模块组合","headline":"【翻译】Terraform 最佳实践：模块组合","description":"原文：https:\/\/www.terraform.io\/language\/modules\/develop\/composition 在只有一个根","inLanguage":"zh","author":{"@type":"Person","name":"顾宇"},"creator":{"@type":"Person","name":"顾宇"},"copyrightHolder":"顾宇","copyrightYear":"2022","dateCreated":"2022-03-06T00:00:00\u002b00:00","datePublished":"2022-03-06T00:00:00\u002b00:00","dateModified":"2022-03-06T00:00:00\u002b00:00","url":"https:\/\/wwww.guyu.me\/blog\/2022-03-17-terraform-module-composition\/","wordCount":"2693","keywords":["Terraform","基础设施即代码"]}</script><meta name=generator content="Hugo 0.94.2"><meta name=author content="顾宇"><link href=https://linkedin.com/in/wizardbyron rel=me><link href=https://github.com/wizardbyron rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><header class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-800 dark:text-neutral"><div><a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" rel=me href=/>顾宇的博客</a></div><nav><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 text-right sm:mb-0 sm:mr-7 sm:last:mr-0"><a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" href=/ title>主页</a></li><li class="mb-1 text-right sm:mb-0 sm:mr-7 sm:last:mr-0"><a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" href=/blog/ title=Blogs>博客文章</a></li><li class="mb-1 text-right sm:mb-0 sm:mr-7 sm:last:mr-0"><a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" href=/tags/ title=Tags>标签分类</a></li><li class="mb-1 text-right sm:mb-0 sm:mr-7 sm:last:mr-0"><a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" href=/guide title>实践指南</a></li><li class="mb-1 text-right sm:mb-0 sm:mr-7 sm:last:mr-0"><a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" href=/about/ title=关于我>关于我</a></li></ul></nav></header><main class=flex-grow><article class=max-w-prose><header><h1 class="mt-0 text-4xl font-extrabold text-neutral-800 dark:text-neutral">【翻译】Terraform 最佳实践：模块组合</h1><div class="mt-8 mb-12 text-base text-neutral-400 dark:text-neutral-500"><div class="flex flex-row items-center"><time datetime="2022-03-06 00:00:00 +0000 UTC">6 March 2022</time><span class="px-2 text-primary-500">&#183;</span><span>2693 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>6 分钟</span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/wizardbyron/wizardbyron.github.io/tree/main/content/blog/2022-03-17-terraform-module-composition.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title=编辑内容><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="far" data-icon="edit" class="svg-inline--fa fa-edit fa-w-18" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1.0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7.0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174 402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7-43.2-43.2c-4.1-4.1-10.8-4.1-14.8.0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg></span></a></span></div></div></header><section class="prose dark:prose-light"><p>原文：<a href=https://www.terraform.io/language/modules/develop/composition>https://www.terraform.io/language/modules/develop/composition</a></p><p>在只有一个根模块的简单 Terraform 配置中，我们创建一组资源并使用 Terraform 的表达式语法来描述这些资源之间的关系：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_vpc&#34;</span> <span style=color:#e6db74>&#34;example&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>cidr_block</span> = <span style=color:#e6db74>&#34;10.1.0.0/16&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_subnet&#34;</span> <span style=color:#e6db74>&#34;example&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vpc_id</span> = <span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>availability_zone</span> = <span style=color:#e6db74>&#34;us-west-2b&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>cidr_block</span>        = cidrsubnet(<span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>cidr_block</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>当我们引入模块时，我们的配置开始变得分层而不是扁平化：每个模块都包含自己的一组资源，可能还有自己的子模块，这可能会创建一个深层、复杂的资源配置树。</p><p>但是，在大多数情况下，我们强烈建议保持模块树扁平化：只有一层子模块，并使用类似于上述的技术，使用表达式来描述模块之间的关系：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;network&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;./modules/aws-network&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>base_cidr_block</span> = <span style=color:#e6db74>&#34;10.0.0.0/8&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;consul_cluster&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;./modules/aws-consul-cluster&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vpc_id</span>     = module.<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>vpc_id</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>subnet_ids</span> = module.<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>subnet_ids</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们将这种扁平化的模块使用方式称为模块组合，因为它需要多个可组合的构建块模块并将它们组装在一起以产生更大的系统。</p><p>模块不是嵌入其依赖项，创建和管理自己的副本，而是从根模块接收其依赖项，因此可以以不同的方式连接相同的模块以产生不同的结果。</p><h2 id=依赖倒置>依赖倒置 <a class=heading-anchor href=#%e4%be%9d%e8%b5%96%e5%80%92%e7%bd%ae aria-label=锚点>#</a></h2><p>在上面的示例中，我们看到了一个名为 <code>consul_cluster</code> 的模块，它可能描述了在 AWS VPC 网络中运行的 <code>HashiCorp Consul</code> 服务器集群，因此它需要 VPC 和该 VPC 内的子网标识符作为参数。</p><p>另一种设计是让 <code>consul_cluster</code> 模块描述它自己的网络资源。如果我们这样做，那么 Consul 集群将很难与同一网络中的其它基础设施共存，所以我们希望尽可能保持模块相对小，并传递它们的依赖项。</p><p>这种依赖倒置方法还提高了未来重构的灵活性，因为 <code>consul_cluster</code> 模块不知道也不关心调用模块如何获取这些标识符。 未来的重构可能会将网络创建分离到自己的配置中，因此我们可以将这些值从数据源传递到模块中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;aws_vpc&#34;</span> <span style=color:#e6db74>&#34;main&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tags</span> = {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Environment</span> = <span style=color:#e6db74>&#34;production&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;aws_subnet_ids&#34;</span> <span style=color:#e6db74>&#34;main&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vpc_id</span> = data.<span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>main</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;consul_cluster&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;./modules/aws-consul-cluster&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vpc_id</span>     = data.<span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>main</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>subnet_ids</span> = data.<span style=color:#a6e22e>aws_subnet_ids</span>.<span style=color:#a6e22e>main</span>.<span style=color:#a6e22e>ids</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=有条件的创建对象>有条件的创建对象 <a class=heading-anchor href=#%e6%9c%89%e6%9d%a1%e4%bb%b6%e7%9a%84%e5%88%9b%e5%bb%ba%e5%af%b9%e8%b1%a1 aria-label=锚点>#</a></h3><p>在跨多个环境使用同一个模块的情况下，通常会看到一些必要的对象已经存在于某些环境中，但在其他环境中还需要创建。</p><p>例如，这可能出现在开发环境场景中：出于成本原因，某些基础架构可能会在多个开发环境中共享，而在生产环境中，基础架构是唯一的，并由生产配置直接管理。</p><p>我们建议采用依赖倒置的方式：让模块通过输入变量接受它需要的对象作为参数，而不是尝试编写一个检测其存在并创建它的模块。</p><p>例如，考虑一个 Terraform 模块基于磁盘映像部署计算实例的情况，并且在某些环境中有一个专用磁盘映像可用，而其他环境共享一个公共基础磁盘映像。与其让模块本身处理这两种情况，不如为表示磁盘映像的对象声明一个输入变量。以 AWS EC2 为例，我们可以声明 aws_ami 资源类型和数据源模式的公共子类型：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;ami&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span> = <span style=color:#a6e22e>object</span>({<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    # 仅使用模块所需的属性子集声明对象。 
</span></span></span><span style=display:flex><span><span style=color:#75715e>    # Terraform 将允许任何至少具有这些属性的对象。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>id</span>           = <span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>architecture</span> = <span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>该模块的调用者现在可以自己直接表示这是要内联创建的 AMI 还是要从其他地方检索的 AMI：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#75715e># 这种情形下我们将自己管理 AMI
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_ami_copy&#34;</span> <span style=color:#e6db74>&#34;example&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>              = <span style=color:#e6db74>&#34;local-copy-of-ami&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source_ami_id</span>     = <span style=color:#e6db74>&#34;ami-abc123&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source_ami_region</span> = <span style=color:#e6db74>&#34;eu-west-1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;example&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;./modules/example&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ami</span> = <span style=color:#a6e22e>aws_ami_copy</span>.<span style=color:#a6e22e>example</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#75715e># 或者，AMI 已经在某处存在了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;aws_ami&#34;</span> <span style=color:#e6db74>&#34;example&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>owner</span> = <span style=color:#e6db74>&#34;9999933333&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tags</span> = {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>application</span> = <span style=color:#e6db74>&#34;example-app&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>environment</span> = <span style=color:#e6db74>&#34;dev&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;example&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;./modules/example&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ami</span> = data.<span style=color:#a6e22e>aws_ami</span>.<span style=color:#a6e22e>example</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这与 Terraform 的声明式风格一致：我们并不构建条件分支复杂的模块，而是直接描述应该存在的内容以及希望 Terraform 管理的内容。</p><p>通过遵循这种风格，我们可以确定在哪些情况下应该 AMI 存在，哪些情况下不应该存在。维护配置的人以后可以了解这些配置的意图，而无需检查云上的状态。</p><p>在上面的示例中，要创建或读取的对象非常简单，可以作为单个资源内联提供，但是在依赖项本身足够复杂以从中受益的情况下，我们也可以将多个模块组合在一起，如本页其他地方所述的一样。</p><h2 id=多云multi-cloud抽象>多云（Multi-cloud）抽象 <a class=heading-anchor href=#%e5%a4%9a%e4%ba%91multi-cloud%e6%8a%bd%e8%b1%a1 aria-label=锚点>#</a></h2><p>Terraform 本身不会尝试抽象不同供应商提供的类似服务，因为我们希望在每个产品中开放全部功能，但在单个接口后面统一多个产品往往需要“最小公分母”方法。</p><p>但是，通过 Terraform 模块的组合，可以通过自己权衡哪些平台功能对您很重要来创建自己的轻量级多云抽象。</p><p>在多个供应商实现相同概念、协议或开放标准的任何情况下，都会出现这种抽象的机会。例如，域名系统的基本功能在所有供应商中都是通用的，尽管一些供应商通过地理定位和智能负载平衡等独特功能来区分自己，但您可能会得出结论，在您的用例中您愿意避开这些功能作为对创建模块的回报，这些模块将多个供应商的通用 DNS 概念抽象化：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;webserver&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;./modules/webserver&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>locals</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fixed_recordsets</span> = [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;www&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>type</span> = <span style=color:#e6db74>&#34;CNAME&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ttl</span>  = <span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>records</span> = [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;webserver01&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;webserver02&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;webserver03&#34;</span>,
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>server_recordsets</span> = [
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>in</span> module.<span style=color:#a6e22e>webserver</span>.<span style=color:#a6e22e>public_ip_addrs</span> <span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span>    = format(<span style=color:#e6db74>&#34;webserver%02d&#34;</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>type</span>    = <span style=color:#e6db74>&#34;A&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>records</span> = [<span style=color:#a6e22e>addr</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;dns_records&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;./modules/route53-dns-records&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>route53_zone_id</span> = var.<span style=color:#a6e22e>route53_zone_id</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>recordsets</span>      = concat(<span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>fixed_recordsets</span>, <span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>server_recordsets</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上面的示例中，我们以“记录集”的形式创建了一个轻量级的抽象。这个抽象包含描述应该可映射到任何 DNS 供应商的 DNS 记录的一般概念的属性。</p><p>然后，我们将该抽象实例化为一个模块。在本例中将记录集部署到 AWS 的 Route53 服务上。</p><p>如果你想以后切换到不同的 DNS 供应商，只需将 dns_records 模块中的内容替换为新供应商的实现，从而使记录集中定义的所有记录配置保持不变。</p><p>你可以在 Terraform 通过定义代表所涉及概念的对象，然后将这些对象类型用于模块输入变量来创建像这样的轻量级抽象。 在这种情况下，所有的“DNS 记录”实现都将声明以下变量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;recordsets&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span> = list(<span style=color:#a6e22e>object</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>    = <span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>type</span>    = <span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ttl</span>     = <span style=color:#a6e22e>number</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>records</span> = list(<span style=color:#a6e22e>string</span>)
</span></span><span style=display:flex><span>  }))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>DNS 只是一个简单的示例，但仍有更多机会利用供应商之间的通用元素。 一个更复杂的例子是部署 Kubernetes 集群，现在有许多不同的供应商提供托管的 Kubernetes 集群服务，甚至还有更多运行 Kubernetes 的方法。</p><p>如果所有这些实现中的通用功能足以满足您的需求，您可以选择实现一组不同的模块来描述特定的 Kubernetes 集群实现，并且都具有将集群的主机名导出为输出值的共同特征：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;hostname&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>value</span> = <span style=color:#a6e22e>azurerm_kubernetes_cluster</span>.<span style=color:#a6e22e>main</span>.<span style=color:#a6e22e>fqdn</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然后，您可以编写仅期望 Kubernetes 集群主机名作为输入的其他模块，并将它们与您的任何 Kubernetes 集群模块互换使用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;k8s_cluster&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;modules/azurerm-k8s-cluster&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # (Azure-specific configuration arguments)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;monitoring_tools&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;modules/monitoring_tools&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>cluster_hostname</span> = module.<span style=color:#a6e22e>k8s_cluster</span>.<span style=color:#a6e22e>hostname</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=只读模块>只读模块 <a class=heading-anchor href=#%e5%8f%aa%e8%af%bb%e6%a8%a1%e5%9d%97 aria-label=锚点>#</a></h2><p>大多数模块都包含 <code>resource</code> 部分，它描述了要创建和管理的基础设施。有时编写根本不描述任何新基础设施，而只用来检索有关使用<code>data sources</code>在其他地方创建的基础设施信息也是一种常见的方式。</p><p>作为模块的使用约定，我们建议仅在模块以某种方式提高抽象级别时才用这种用法。在这种情况下会通过精确封装的数据的检索方式。</p><p>这种技术的一个常见用途是当一个系统被分解为几个子系统配置，但某些基础设施在各子子系统之间共享的时候。例如一个公共 IP 网络。 在这种情况下，我们可能会编写一个名为 <code>join-network-aws</code> 的共享模块，当部署在 AWS 中时，任何需要共享网络信息的配置都可以调用该模块：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;network&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;./modules/join-network-aws&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>environment</span> = <span style=color:#e6db74>&#34;production&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;k8s_cluster&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;./modules/aws-k8s-cluster&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>subnet_ids</span> = module.<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>aws_subnet_ids</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>网络模块本身可以通过多种不同的方式检索这些数据：它可以使用 <code>aws_vpc</code> 和 <code>aws_subnet_ids</code> 数据源直接查询 AWS API，或者它可以使用 <code>consul_keys</code> 从 Consul 集群中读取保存的信息，或者它可以直接从 使用 <code>terraform_remote_state</code> 管理网络的配置状态。</p><p>这种方法的主要好处是，此信息的来源可以随时间变化，而无需更新依赖它的每个配置。 此外，如果您将纯数据模块设计为具有与相应管理模块相似的一组输出，则在重构时可以相对轻松地在两者之间进行切换。</p><p>(完)</p></section><footer class=pt-8><div class=flex><img class="w-24 h-24 !mt-0 !mb-0 mr-4 rounded-full" src=/img/author.jpg><div class=place-self-center><div class="text-[0.6rem] leading-3 text-neutral-400 dark:text-neutral-500 uppercase">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">顾宇</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Stand Alone CompleX</div><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/wizardbyron target=_blank alt=Linkedin rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/wizardbyron target=_blank alt=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div><div class="pt-8 article-pagination"><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span></span><span><a class="flex text-right" href=/blog/2022-02-15-kdl/><span class="flex flex-col"><span class="article-pagination-title mt-[0.1rem] leading-6">【翻译】Kubernetes 部署语言（Kubernetes Deployment Language）</span>
<span class="mt-[0.1rem] text-xs text-neutral-400 dark:text-neutral-500"><time datetime="2022-02-15 00:00:00 +0000 UTC">15 February 2022</time></span></span>
<span class="ml-3 article-pagination-direction">&rarr;</span></a></span></div></div></footer></article></main><footer class=py-10><div class="flex justify-between"><div><p class="text-sm text-neutral-400 dark:text-neutral-500">&copy;
2022
顾宇</p><p class="text-xs text-neutral-300 dark:text-neutral-600">由 <a class="hover:underline hover:underline-primary-300 hover:text-primary-400" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:underline-primary-300 hover:text-primary-400" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a> 强力驱动</p></div><div class="text-sm cursor-pointer text-neutral-400 dark:text-neutral-500"><button id=dark-toggle onclick='setPreferredAppearance("dark")' oncontextmenu='return setPreferredAppearance("default"),!1' class="inline px-2 py-1 border rounded-md border-neutral-200 dark:hidden hover:text-primary-500 hover:border-primary-400" title=切换为深色模式>
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="moon" class="svg-inline--fa fa-moon fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M283.211 512c78.962.0 151.079-35.925 198.857-94.792 7.068-8.708-.639-21.43-11.562-19.35-124.203 23.654-238.262-71.576-238.262-196.954.0-72.222 38.662-138.635 101.498-174.394 9.686-5.512 7.25-20.197-3.756-22.23A258.156 258.156.0 00283.211.0c-141.309.0-256 114.511-256 256 0 141.309 114.511 256 256 256z"/></svg></span></button>
<button id=light-toggle onclick='setPreferredAppearance("light")' oncontextmenu='return setPreferredAppearance("default"),!1' class="hidden px-2 py-1 border rounded-md cursor-pointer dark:inline border-neutral-700 hover:text-primary-400 hover:border-primary-500" title=切换为浅色模式>
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="sun" class="svg-inline--fa fa-sun fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 160c-52.9.0-96 43.1-96 96s43.1 96 96 96 96-43.1 96-96-43.1-96-96-96zm246.4 80.5-94.7-47.3 33.5-100.4c4.5-13.6-8.4-26.5-21.9-21.9l-100.4 33.5-47.4-94.8c-6.4-12.8-24.6-12.8-31 0l-47.3 94.7L92.7 70.8c-13.6-4.5-26.5 8.4-21.9 21.9l33.5 100.4-94.7 47.4c-12.8 6.4-12.8 24.6.0 31l94.7 47.3-33.5 100.5c-4.5 13.6 8.4 26.5 21.9 21.9l100.4-33.5 47.3 94.7c6.4 12.8 24.6 12.8 31 0l47.3-94.7 100.4 33.5c13.6 4.5 26.5-8.4 21.9-21.9l-33.5-100.4 94.7-47.3c13-6.5 13-24.7.2-31.1zm-155.9 106c-49.9 49.9-131.1 49.9-181 0s-49.9-131.1.0-181 131.1-49.9 181 0 49.9 131.1.0 181z"/></svg></span></button></div></div></footer></body></html>